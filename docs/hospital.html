<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hospital Map</title>
    <style>
        * { margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }

        .current-location-marker {
            width: 24px;
            height: 24px;
            position: relative;
        }
        .current-location-marker .pulse {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(66, 133, 244, 0.3);
            animation: pulse 2s ease-out infinite;
        }
        .current-location-marker .dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            background: #4285F4;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var apiKey = urlParams.get('key') || '';
        var initLat = parseFloat(urlParams.get('lat')) || 37.5665;
        var initLng = parseFloat(urlParams.get('lng')) || 126.9780;
    </script>
    <script>
        document.write('<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + apiKey + '&autoload=false"><\/script>');
    </script>
    <script>
        var map = null;
        var markers = [];
        var currentLocationMarker = null;

        function log(msg) {
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.consoleLog) {
                window.webkit.messageHandlers.consoleLog.postMessage(msg);
            }
        }

        function notifyMapReady() {
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.mapReady) {
                window.webkit.messageHandlers.mapReady.postMessage('ready');
            }
        }

        window.onload = function() {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                log('Kakao Maps SDK not loaded');
                return;
            }

            kakao.maps.load(function() {
                log('Kakao Maps SDK loaded');

                var container = document.getElementById('map');
                var options = {
                    center: new kakao.maps.LatLng(initLat, initLng),
                    level: 5
                };

                map = new kakao.maps.Map(container, options);
                setCurrentLocation(initLat, initLng);
                notifyMapReady();
            });
        };

        function setCenter(lat, lng) {
            if (!map) return;
            var position = new kakao.maps.LatLng(lat, lng);
            map.panTo(position);
        }

        function setCurrentLocation(lat, lng) {
            if (!map) return;

            var position = new kakao.maps.LatLng(lat, lng);

            if (currentLocationMarker) {
                currentLocationMarker.setPosition(position);
            } else {
                var content = '<div class="current-location-marker">' +
                              '<div class="pulse"></div>' +
                              '<div class="dot"></div>' +
                              '</div>';

                currentLocationMarker = new kakao.maps.CustomOverlay({
                    position: position,
                    content: content,
                    yAnchor: 0.5,
                    xAnchor: 0.5,
                    zIndex: 10
                });
                currentLocationMarker.setMap(map);
            }
        }

        function addMarker(lat, lng, title, id) {
            if (!map) return;

            var position = new kakao.maps.LatLng(lat, lng);

            var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
            var imageSize = new kakao.maps.Size(24, 35);
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

            var marker = new kakao.maps.Marker({
                position: position,
                title: title,
                image: markerImage
            });

            marker.setMap(map);
            markers.push(marker);

            kakao.maps.event.addListener(marker, 'click', function() {
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.markerTapped) {
                    window.webkit.messageHandlers.markerTapped.postMessage(id);
                }
            });
        }

        function clearMarkers() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }
    </script>
</body>
</html>
