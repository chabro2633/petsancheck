<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Walk Map</title>
    <style>
        * { margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }

        .current-location-marker {
            width: 24px;
            height: 24px;
            position: relative;
        }
        .current-location-marker .pulse {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(66, 133, 244, 0.3);
            animation: pulse 2s ease-out infinite;
        }
        .current-location-marker .dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            background: #4285F4;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var apiKey = urlParams.get('key') || '';
        var initLat = parseFloat(urlParams.get('lat')) || 37.5665;
        var initLng = parseFloat(urlParams.get('lng')) || 126.9780;
    </script>
    <script>
        document.write('<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + apiKey + '&autoload=false"><\/script>');
    </script>
    <script>
        var map = null;
        var currentLocationMarker = null;
        var routePolyline = null;
        var routeCoordinates = [];
        var startMarker = null;

        function log(msg) {
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.consoleLog) {
                window.webkit.messageHandlers.consoleLog.postMessage(msg);
            }
        }

        function notifyMapReady() {
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.mapReady) {
                window.webkit.messageHandlers.mapReady.postMessage('ready');
            }
        }

        window.onload = function() {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                log('Kakao Maps SDK not loaded');
                return;
            }

            kakao.maps.load(function() {
                log('Kakao Maps SDK loaded');

                var container = document.getElementById('map');
                var options = {
                    center: new kakao.maps.LatLng(initLat, initLng),
                    level: 3
                };

                map = new kakao.maps.Map(container, options);
                setCurrentLocation(initLat, initLng);
                notifyMapReady();
            });
        };

        function setCenter(lat, lng) {
            if (!map) return;
            var position = new kakao.maps.LatLng(lat, lng);
            map.panTo(position);
        }

        function setCurrentLocation(lat, lng) {
            if (!map) return;

            var position = new kakao.maps.LatLng(lat, lng);

            if (currentLocationMarker) {
                currentLocationMarker.setPosition(position);
            } else {
                var content = '<div class="current-location-marker">' +
                              '<div class="pulse"></div>' +
                              '<div class="dot"></div>' +
                              '</div>';

                currentLocationMarker = new kakao.maps.CustomOverlay({
                    position: position,
                    content: content,
                    yAnchor: 0.5,
                    xAnchor: 0.5,
                    zIndex: 10
                });
                currentLocationMarker.setMap(map);
            }
            map.panTo(position);
        }

        function setRoute(coordsJson) {
            if (!map) return;

            try {
                var coords = JSON.parse(coordsJson);
                routeCoordinates = coords.map(function(c) {
                    return new kakao.maps.LatLng(c.latitude, c.longitude);
                });

                if (routePolyline) {
                    routePolyline.setMap(null);
                }

                routePolyline = new kakao.maps.Polyline({
                    path: routeCoordinates,
                    strokeWeight: 5,
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.8,
                    strokeStyle: 'solid'
                });
                routePolyline.setMap(map);

                if (coords.length > 0) {
                    if (startMarker) {
                        startMarker.setMap(null);
                    }
                    startMarker = new kakao.maps.Marker({
                        position: routeCoordinates[0],
                        map: map
                    });
                }
            } catch (e) {
                log('Error setting route: ' + e.message);
            }
        }

        function addRoutePoint(lat, lng) {
            if (!map) return;

            var position = new kakao.maps.LatLng(lat, lng);
            routeCoordinates.push(position);

            if (routePolyline) {
                routePolyline.setPath(routeCoordinates);
            } else {
                routePolyline = new kakao.maps.Polyline({
                    path: routeCoordinates,
                    strokeWeight: 5,
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.8,
                    strokeStyle: 'solid'
                });
                routePolyline.setMap(map);
            }
        }

        function clearRoute() {
            if (routePolyline) {
                routePolyline.setMap(null);
                routePolyline = null;
            }
            if (startMarker) {
                startMarker.setMap(null);
                startMarker = null;
            }
            routeCoordinates = [];
        }
    </script>
</body>
</html>
